name: "Release"

on:
  push:
    tags:
      - "v*"
      - "devbox-v*"
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        type: string
      branch:
        description: 'ç›®æ ‡åˆ†æ”¯ (ä¾‹å¦‚: main, feat/urlencodeTool)'
        required: true
        default: 'main'
        type: string

permissions:
  contents: write

jobs:
  validate-tag:
    name: æ ¡éªŒ Tag æ¥æºå¹¶æå–ç‰ˆæœ¬
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      suffix: ${{ steps.meta.outputs.suffix }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ ¡éªŒ Tag æ¥æºåˆ†æ”¯
        if: github.event_name == 'push'
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          
          # åˆ¤æ–­ tag åç¼€ï¼Œç¡®å®šç›®æ ‡åˆ†æ”¯
          if [[ "$TAG" == *"-urlencode"* ]]; then
            TARGET_BRANCH="feat/urlencodeTool"
          else
            TARGET_BRANCH="main"
          fi
          
          echo "ğŸ“‹ Tag: $TAG"
          echo "ğŸ¯ ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
          
          git fetch origin "$TARGET_BRANCH" --no-tags
          if ! git merge-base --is-ancestor "$GITHUB_SHA" "origin/$TARGET_BRANCH"; then
            echo "âŒ å½“å‰ tag å¯¹åº”æäº¤ä¸åœ¨ $TARGET_BRANCH åˆ†æ”¯ä¸Š"
            exit 1
          fi
          echo "âœ… Tag æ¥æºæ ¡éªŒé€šè¿‡"

      - name: æå–ç‰ˆæœ¬ä¿¡æ¯
        id: meta
        run: |
          set -euo pipefail
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘
            VERSION="${{ github.event.inputs.version }}"
            SUFFIX="${{ github.event.inputs.branch }}"
            if [ "$SUFFIX" != "main" ]; then
              TAG="v${VERSION}-${SUFFIX}"
            else
              TAG="v${VERSION}"
            fi
          else
            # Tag è§¦å‘
            TAG="${GITHUB_REF_NAME}"
            VERSION="$(echo "$TAG" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)"
            # æå–åç¼€ï¼ˆå¦‚ -urlencodeï¼‰
            SUFFIX="$(echo "$TAG" | sed -E 's/^v[0-9]+\.[0-9]+\.[0-9]+//' | sed 's/^-//')"
          fi
          
          if [ -z "$VERSION" ]; then
            echo "âŒ æ— æ³•æå–ç‰ˆæœ¬å·"
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "suffix=$SUFFIX" >> "$GITHUB_OUTPUT"
          echo "âœ… å‘å¸ƒç‰ˆæœ¬: $VERSION${SUFFIX:+-$SUFFIX}"

  build-windows:
    name: æ„å»º Windows ç‰ˆæœ¬
    needs: validate-tag
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: å®‰è£… Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: ./frontend
        run: npm install

      - name: æ„å»º Windows x64 ç‰ˆæœ¬
        env:
          GOARCH: amd64
          CGO_ENABLED: 1
        run: |
          wails build -platform windows/amd64 -ldflags "-X main.version=${{ needs.validate-tag.outputs.version }}"

      - name: é‡å‘½åæ„å»ºäº§ç‰©
        run: |
          $version = "${{ needs.validate-tag.outputs.version }}"
          $source = "build/bin/DevBox.exe"
          $target = "DevBox_" + $version + "_windows_x64.exe"
          $targetPath = "build/bin/" + $target

          if (Test-Path $source) {
            Rename-Item -Path $source -NewName $target
            Write-Host "âœ… é‡å‘½åå®Œæˆ: $targetPath"
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ°æ„å»ºäº§ç‰©: $source"
            exit 1
          }

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-x64
          path: build/bin/*.exe
          if-no-files-found: error

  build-macos:
    name: æ„å»º macOS ç‰ˆæœ¬
    needs: validate-tag
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            goarch: amd64
            platform: x64
          - arch: arm64
            goarch: arm64
            platform: arm64
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: å®‰è£… Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: å®‰è£… create-dmg
        run: |
          brew install create-dmg

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: ./frontend
        run: npm install

      - name: æ„å»º macOS ${{ matrix.platform }} ç‰ˆæœ¬
        env:
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
        run: |
          wails build -platform darwin/${{ matrix.goarch }} -ldflags "-X main.version=${{ needs.validate-tag.outputs.version }}"

      - name: åˆ›å»º DMG å®‰è£…åŒ…
        run: |
          VERSION="${{ needs.validate-tag.outputs.version }}"
          ARCH="${{ matrix.platform }}"
          APP_NAME="DevBox"
          APP_PATH="build/bin/${APP_NAME}.app"
          DMG_NAME="${APP_NAME}_${VERSION}_macos_${ARCH}.dmg"

          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° .app æ–‡ä»¶: $APP_PATH"
            ls -la build/bin/
            exit 1
          fi

          create-dmg \
            --volname "${APP_NAME} Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "${APP_NAME}.app" 200 190 \
            --hide-extension "${APP_NAME}.app" \
            --app-drop-link 600 185 \
            "build/bin/${DMG_NAME}" \
            "$APP_PATH"

          echo "âœ… DMG åˆ›å»ºå®Œæˆ: build/bin/${DMG_NAME}"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-${{ matrix.arch }}
          path: build/bin/*.dmg
          if-no-files-found: error

  release:
    name: åˆ›å»º Release å¹¶ä¸Šä¼ 
    needs: [validate-tag, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: '*-build-*'
          merge-multiple: true

      - name: åˆ—å‡ºæ„å»ºäº§ç‰©
        run: |
          echo "ğŸ“¦ æ„å»ºäº§ç‰©åˆ—è¡¨:"
          ls -la ./artifacts/

      - name: åˆ›å»º Release å¹¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-tag.outputs.tag }}
          name: "DevBox v${{ needs.validate-tag.outputs.version }}${{ needs.validate-tag.outputs.suffix && format('-{0}', needs.validate-tag.outputs.suffix) || '' }}"
          body: |
            ## DevBox v${{ needs.validate-tag.outputs.version }}${{ needs.validate-tag.outputs.suffix && format('-{0}', needs.validate-tag.outputs.suffix) || '' }}

            ### Windows ç‰ˆæœ¬

            | æ¶æ„ | æ–‡ä»¶å |
            |------|--------|
            | x64 (64ä½) | DevBox_${{ needs.validate-tag.outputs.version }}_windows_x64.exe |

            ### macOS ç‰ˆæœ¬

            | æ¶æ„ | æ–‡ä»¶å |
            |------|--------|
            | x64 (Intel) | DevBox_${{ needs.validate-tag.outputs.version }}_macos_x64.dmg |
            | arm64 (Apple Silicon) | DevBox_${{ needs.validate-tag.outputs.version }}_macos_arm64.dmg |

            ### å®‰è£…è¯´æ˜

            #### Windows
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„å¯æ‰§è¡Œæ–‡ä»¶
            2. åŒå‡»è¿è¡Œå³å¯ä½¿ç”¨

            #### macOS
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ DMG æ–‡ä»¶
            2. åŒå‡»æ‰“å¼€ DMG
            3. å°†åº”ç”¨æ‹–åˆ° Applications æ–‡ä»¶å¤¹
            4. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å‰å¾€ ç³»ç»Ÿè®¾ç½® > éšç§ä¸å®‰å…¨æ€§ å…è®¸è¿è¡Œ

            ### æ ¡éªŒ

            è¯·éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚
          files: |
            ./artifacts/*.exe
            ./artifacts/*.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
