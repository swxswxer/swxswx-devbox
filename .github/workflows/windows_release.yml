name: "Windows Release"

on:
  push:
    tags:
      - "v*"
      - "swxTools-v*"

permissions:
  contents: write

jobs:
  validate-tag:
    name: æ ¡éªŒ Tag æ¥æºå¹¶æå–ç‰ˆæœ¬
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ ¡éªŒ Tag æŒ‡å‘ main åˆ†æ”¯æäº¤
        run: |
          set -euo pipefail
          git fetch origin main --no-tags
          if ! git merge-base --is-ancestor "$GITHUB_SHA" origin/main; then
            echo "âŒ å½“å‰ tag (${GITHUB_REF_NAME}) å¯¹åº”æäº¤ä¸åœ¨ main åˆ†æ”¯ä¸Š"
            exit 1
          fi
          echo "âœ… Tag æ¥æºæ ¡éªŒé€šè¿‡"

      - name: æå–ç‰ˆæœ¬ä¿¡æ¯
        id: meta
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          VERSION="$(echo "$TAG" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)"
          if [ -z "$VERSION" ]; then
            echo "âŒ æ— æ³•ä» tag æå–ç‰ˆæœ¬å·: $TAG"
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "âœ… å‘å¸ƒç‰ˆæœ¬: $VERSION"

  build-windows:
    name: æ„å»º Windows ç‰ˆæœ¬
    needs: validate-tag
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            goarch: amd64
            platform: x64
          - arch: arm64
            goarch: arm64
            platform: arm64

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: å®‰è£… Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: ./frontend
        run: npm install

      - name: ç¼“å­˜ Go æ¨¡å—
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: æ„å»º Windows ${{ matrix.platform }} ç‰ˆæœ¬
        env:
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
        run: |
          wails build -platform windows/${{ matrix.goarch }} -ldflags "-X main.version=${{ needs.validate-tag.outputs.version }}"

      - name: é‡å‘½åæ„å»ºäº§ç‰©
        run: |
          $version = "${{ needs.validate-tag.outputs.version }}"
          $arch = "${{ matrix.platform }}"
          $source = "build/bin/swxTools.exe"
          $target = "build/bin/swxTools_${version}_windows_${arch}.exe"
          
          if (Test-Path $source) {
            Rename-Item -Path $source -NewName $target
            Write-Host "âœ… é‡å‘½åå®Œæˆ: $target"
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ°æ„å»ºäº§ç‰©: $source"
            exit 1
          }

      - name: åˆ›å»ºå®‰è£…åŒ… (NSIS)
        if: matrix.arch == 'amd64'
        run: |
          # æ£€æŸ¥æ˜¯å¦å®‰è£…äº† NSIS
          if (Get-Command makensis -ErrorAction SilentlyContinue) {
            Write-Host "âœ… NSIS å·²å®‰è£…"
          } else {
            Write-Host "âš ï¸ NSIS æœªå®‰è£…ï¼Œè·³è¿‡å®‰è£…åŒ…åˆ›å»º"
          }

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-${{ matrix.arch }}
          path: build/bin/*.exe
          if-no-files-found: error

  release:
    name: åˆ›å»º Release å¹¶ä¸Šä¼ 
    needs: [validate-tag, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: windows-build-*
          merge-multiple: true

      - name: åˆ—å‡ºæ„å»ºäº§ç‰©
        run: |
          echo "ğŸ“¦ æ„å»ºäº§ç‰©åˆ—è¡¨:"
          ls -la ./artifacts/

      - name: åˆ›å»º Release å¹¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-tag.outputs.tag }}
          name: "swxTools v${{ needs.validate-tag.outputs.version }} (Windows)"
          body: |
            ## swxTools v${{ needs.validate-tag.outputs.version }}

            ### Windows ç‰ˆæœ¬

            | æ¶æ„ | æ–‡ä»¶å |
            |------|--------|
            | x64 (64ä½) | swxTools_${{ needs.validate-tag.outputs.version }}_windows_x64.exe |
            | arm64 | swxTools_${{ needs.validate-tag.outputs.version }}_windows_arm64.exe |

            ### å®‰è£…è¯´æ˜

            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„å¯æ‰§è¡Œæ–‡ä»¶
            2. åŒå‡»è¿è¡Œå³å¯ä½¿ç”¨

            ### æ ¡éªŒ

            è¯·éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚
          files: |
            ./artifacts/*.exe
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
